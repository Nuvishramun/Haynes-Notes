%%
%% Join-tikz-cd
%%
%% A package to horizontally concatenate tikz-cd diagrams.
%% Hopefully should make diagram maitenence easier.
%% If vertical joins seem like they will be useful, I may at some point add them.
%%
%% It might be nice at some point to hand code the environ functionality I need, to reduce the dependencies
%%

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{join-tikz-cd}
\RequirePackage{tikz-cd}
\RequirePackage{environ}
\RequirePackage{etoolbox}


\let\@xp\expandafter
\let\@nx\noexpand

\newcount\jtcd@rowskip
\jtcd@rowskip=1
\tikzcdset{intertext/.code={\jtcd@rowskip=2\def\pgfmatrixendrow{\jtcdsl\jtcdsl}\let\\\pgfmatrixendrow\let\intertext\jtcd@intertextslsl}}

% TODO: diagram sep
% Also allow individual setting of diagram separation


%
% Redefine a command from tikzcd so I can change the effect of u and d to go up or down two rows.
%
\def\tikzcd@parse#1{% parser for arrow direction argument
  \ifx#1r\advance\c@pgf@countb by1\else%
   \ifx#1d\advance\c@pgf@counta by\jtcd@rowskip\else%
    \ifx#1l\advance\c@pgf@countb by-1\else%
     \ifx#1u\advance\c@pgf@counta by-\jtcd@rowskip\else%
      \ifx#1\relax\let\tikzcd@temp\pgfutil@empty%
       \else\let\tikzcd@temp\pgfutil@gobble@until@relax\fi\fi\fi\fi\fi%
  \tikzcd@temp}

\def\jtcd@intertext#1{|[inner sep=0pt]|\hskip-1em\smash{\textup{#1}}\hskip-1em}
\def\jtcd@intertextslsl#1{\jtcdsl|[inner sep=0pt]|\hskip-1em\smash{\textup{#1}}\hskip-1em\jtcdsl}


%% From TUGBoat Volume 22 (2001), No. 4
%% https://www.tug.org/TUGboat/tb22-4/tb72perlS.pdf
%%

\def\clap#1{\hbox to 0pt{\hss#1\hss}}
\def\mathllap{\mathpalette\mathllapinternal}
\def\mathrlap{\mathpalette\mathrlapinternal}
\def\mathclap{\mathpalette\mathclapinternal}
\def\mathllapinternal#1#2{\llap{$\mathsurround=0pt#1{#2}$}}
\def\mathrlapinternal#1#2{\rlap{$\mathsurround=0pt#1{#2}$}}
\def\mathclapinternal#1#2{\clap{$\mathsurround=0pt#1{#2}$}}

%%
%%


\newbox\tempbox
\newtoks\ctikzcdphantomleft
\newtoks\ctikzcdphantomright
\def\edgellap#1{\mathllap{#1{}}\global\ctikzcdphantomleft={\sbox\tempbox{$#1{}$}\wd\tempbox=-\wd\tempbox\hbox to \wd\tempbox{}}}%\hskip\wd\tempbox}}
\def\edgerlap#1{\mathrlap{{}#1}\hskip-1ex\global\ctikzcdphantomright={\phantom{${}#1$}}}

\newenvironment{ctikzcd}{\begin{center}\tikzcd}{\endtikzcd\the\ctikzcdphantomleft\the\ctikzcdphantomright\global\ctikzcdphantomleft={}\global\ctikzcdphantomright={}\end{center}}

%%%
%
%
%
%%%

\def\macroname{\@xp\@gobble\string}
\edef\theworddiagram{\macroname\diagram}
\def\@gobblediagram#1{\edef\test{\macroname#1}\ifx\test\theworddiagram\else \PackageError{join-tikz-cd}{The body of the jointikzcd environment must start with a \protect\diagram}{}\fi}

\newcount\jtcd@currow
\newcount\jtcd@maxamps
\newcount\jtcd@amps
\newtoks\temptoks

% \@nil needs to have distinct expansion text so that \@ifnextchar can tell it apart from other macros
% Also, the only way that \@nil seems to get expanded is if the environment is empty. Hence:
\def\jtcd@nil{\PackageError{join-tikz-cd}{There is probably an empty jointikzcd environment}{}}

\bgroup\lccode`~=`&\lowercase{
    \newtoks\savedamps
    \def\padamps{%
        \ifnum\jtcd@amps>\jtcd@maxamps %
            \ifnum\jtcd@maxamps=-1%
                \global\jtcd@maxamps=\jtcd@amps  %
            \else
                \PackageError{join-tikz-cd}{Either the top row must have the most columns or you must explicitly indicate how many columns are present in a subdiagram by saying \protect\diagram[n]}{}
            \fi
        \else %
            \loop\ifnum\jtcd@amps<\jtcd@maxamps%
                \@xp\savedamps\@xp{\the\savedamps ~}%
                \advance\jtcd@amps1%
            \repeat %
            \the\savedamps %
        \fi %
        \global\jtcd@amps=0%
    }

    \def\jtcdsl#1\diagram{\@ifnextchar\@nil{\jtcdsl@nil{#1}}{\@ifnextchar[{\jtcdsl@diagram{#1}}{\jtcdsl@diagram{#1}[-1]}}} %}
    \def\jtcdsl@nil#1{ %
        \edef\temp{\@nx\temptoks{\the\temptoks[\the\jtcd@maxamps]}}\temp %
        \@xp\global\@xp\temptoks\@xp{\the\temptoks#1\diagram}%
        \jtcdsaved@pgfmatrixendrow %
        \global\jtcd@amps=0
        \@xp\global\@xp\temptoks\@xp{\@xp}%
        \the\temptoks %
    }
    \def\jtcdsl@diagram#1[#2]{%
        \padamps
        \edef\temp{\@nx\temptoks{\the\temptoks[\the\jtcd@maxamps]}}\temp %
        \@xp\global\@xp\temptoks\@xp{\the\temptoks#1\diagram}%
        \global\jtcd@maxamps=#2%
        ~%
    }

    \def\jtcd@diagram{\@ifnextchar\@nil{\global\jtcd@amps=0\let\pgfmatrixendrow\jtcdsaved@pgfmatrixendrow\let\\\pgfmatrixendrow\@gobble}{\@ifnextchar[{\jtcd@diagram@}{\jtcd@diagram@[-1]}}} %}
    \def\jtcd@diagram@[#1]{\padamps\global\jtcd@maxamps=#1~}
    \def\jtcd@startdiagram{\@ifnextchar[{\jtcd@startdiagram@}{\jtcd@startdiagram@[-1]}} %}
    \def\jtcd@startdiagram@[#1]{\global\jtcd@maxamps=#1 \global\temptoks{\jtcd@startdiagram@}}

    \NewEnviron{cjointikzcd}[1][]{%
        \let\jtcdsaved@pgfmatrixendrow\pgfmatrixendrow\let\pgfmatrixendrow\jtcdsl %
        \let\intertext\jtcd@intertext
        \let\@nil\jtcd@nil
        \let\diagram\jtcd@diagram
        \begin{center}
        \begin{tikzcd}[#1] %
            \pretocmd{\pgfmatrixnextcell}{\global\advance\jtcd@amps1}{}{} %
            \global\let~\pgfmatrixnextcell%
            \@xp\@xp\@xp\jtcd@startdiagram\@xp\@gobblediagram\BODY\diagram\@nil %
        \end{tikzcd} %
        \end{center}
    }
}

\def\cjointikzcd{\catcode`&=\active \Collect@Body \env@cjointikzcd@parse}
