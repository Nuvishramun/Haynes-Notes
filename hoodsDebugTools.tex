\usepackage{verbatim}

% Make \include track say which file it is currently working on
\let\oldinclude\include
\def\include#1{\def\currentfile{#1}\oldinclude{#1}\let\currentfile\relax}

\newtoks\fileslist
\let\@xp\expandafter
\def\appendtolist#1#2{\edef\temp{\@nx\global\@nx#1{\the#1\@nx\\{#2}}}\temp}

\def\newtally#1{\@xp\newcount\csname #1@tally\endcsname}
\def\thetally#1{\@xp\the\csname #1@tally\endcsname}
\def\advancetally#1{\@xp\global\@xp\advance\csname #1@tally\endcsname1\relax}


\def\recordcommanduse{
    \def\next{\appendtolist\fileslist{\currentfile}\newtally{\currentfile}}
    \def\\##1{\def\temp{##1}\ifx\currentfile\temp\let\next\relax\fi}
    \the\fileslist
    \next
    \advancetally{\currentfile}
}

\def\trackcommand#1{\let#1\recordcommanduse}
\def\trackenvironment#1{\def#1{\recordcommanduse\comment}}

\AtEndDocument{\let\next\relax\message{^^J Command usage:}\def\\#1{\message{^^J#1: \thetally{#1}}\let\next\error}\the\fileslist\next}


%%
\begin{comment}
\newtoks\trackedcommands

\def\recordcommandsuse#1{
    \@xp\ifndef\csname #1@fileslist\endcsname
        \@xp\newtoks\csname #1@fileslist\endcsname
    \fi
    
    \def\next{\@xp\appendtolist\csname #1@fileslist\endcsname{\currentfile}\newtally{#1@\currentfile}}
    \def\\##1{\def\temp{##1}\ifx\currentfile\temp\let\next\relax\fi}
    \@xp\the\csname #1@fileslist\endcsname
    \next
    \advancetally{#1@\currentfile}
}

\def\atenditercommands#1{{\message{^^J #1 Command usage:}\def\\##1{\message{^^J #1: \thetally{#1@##1}}}\@xp\the\csname #1@fileslist\endcsname}}

\def\commandname#1{\@xp\@gobble\string#1}

\let\oldnewcommand\newcommand
\def\newcommand#1{}

\AtEndDocument{\let\\\atenditercommands \the\trackedcommands}
\end{comment}
